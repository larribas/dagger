apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: key-only-artifacts-
spec:
  entrypoint: main
  templates:
    - name: main
      dag:
        tasks:
          - name: generate
            template: generate
          - name: consume
            template: consume
            dependencies:
              - generate
            arguments:
              artifacts:
              - name: number
                s3:
                  key: "{{workflow.uid}}/generate/numbers.json/{{item}}"
            withParam: "{{tasks.generate.outputs.parameters.partitions}}"
    - name: generate
      outputs:
        artifacts:
        - name: numbers
          path: /tmp/outputs/numbers.json
          archive:
            none: { }
          s3:
            key: "{{workflow.uid}}/generate/numbers.json"
        parameters:
        - name: partitions
          valueFrom:
            path: "{{outputs.artifacts.numbers.path}}/partitions.json"
      script:
        image: python:alpine3.6
        command: [python]
        source: |
          import os
          os.mkdir("/tmp/outputs/numbers.json")

          import random
          partitions = [i+4 for i in list(range(random.randint(3,10)))]
          for i in partitions:
            with open(f"/tmp/outputs/numbers.json/{i}", "w") as f:
              f.write(str(i))

          import json
          with open("/tmp/outputs/numbers.json/partitions.json", "w") as f:
            f.write(json.dumps(partitions))

          import glob
          print(glob.glob("/tmp/outputs/numbers.json/*"))
        volumeMounts:
        - mountPath: /tmp/outputs/
          name: outputs
      volumes:
      - emptyDir: {}
        name: outputs

    - name: consume
      inputs:
        artifacts:
        - name: number
          path: /tmp/inputs/number.json
      script:
        image: python:alpine3.6
        command: [python]
        source: |
          import glob
          print(glob.glob("/tmp/inputs/numbers.json/*"))

          import json
          with open("/tmp/inputs/number.json", "r") as f:
            print(json.loads(f.read()))
